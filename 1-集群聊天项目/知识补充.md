# `std::bind` ä½¿ç”¨æ€»ç»“ï¼ˆC++11ï¼‰

## 1. ç»‘å®šæ™®é€šå‡½æ•°

```
int add(int a, int b) { return a + b; }

auto f = std::bind(add, 1, 2);
f(); // => 3
```

## 2. ä½¿ç”¨å ä½ç¬¦ `_1`, `_2`ï¼Œè°ƒç”¨æ—¶ä¼ å‚æ•°

```
using namespace std::placeholders;

auto f = std::bind(add, _1, 10);
f(5); // => 15
```

## 3. ç»‘å®šç±»çš„æˆå‘˜å‡½æ•°ï¼ˆç±»å¤–ï¼‰

```
class A {
public:
    void say(int x) { std::cout << "x=" << x << std::endl; }
};

A a;
auto f = std::bind(&A::say, &a, 100);
f(); // è¾“å‡ºï¼šx=100
```

## 4. ç»‘å®šç±»çš„æˆå‘˜å‡½æ•°ï¼ˆç±»å†…ï¼‰

```
class A {
public:
    A() {
        auto f = std::bind(&A::say, this, 100);
        f(); // è¾“å‡ºï¼šx=100
    }
    void say(int x) { std::cout << "x=" << x << std::endl; }
};
```

## 5. å ä½ç¬¦ç»“åˆæˆå‘˜å‡½æ•°

```
auto f = std::bind(&A::say, &a, _1);
f(42); // è¾“å‡ºï¼šx=42
```

## å°ç»“

- **æ™®é€šå‡½æ•°**ç›´æ¥ç»‘å®šæˆ–é…åˆå ä½ç¬¦
- **æˆå‘˜å‡½æ•°**å¿…é¡»æä¾›å¯¹è±¡ï¼ˆ`this` æˆ– `&obj`ï¼‰
- **å ä½ç¬¦ `_1`, `_2`** è¡¨ç¤ºå»¶åä¼ å‚



# miané˜¶æ®µ-->

# cerr, perrorå’Œ strerror

éƒ½æ˜¯ C++ ä¸­ç”¨äºé”™è¯¯è¾“å‡ºçš„å·¥å…·ï¼Œä½†å®ƒä»¬çš„ç”¨æ³•å’Œè¡Œä¸ºæœ‰æ‰€ä¸åŒã€‚

### 1. `cerr`

- **ç±»å‹**ï¼š`cerr` æ˜¯ C++ æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªè¾“å‡ºæµå¯¹è±¡ï¼Œå±äº `std::ostream` ç±»å‹ã€‚
- **ç”¨é€”**ï¼šç”¨äºè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œé€šå¸¸è¾“å‡ºåˆ°æ ‡å‡†é”™è¯¯æµï¼ˆstderrï¼‰ã€‚
- **ç‰¹ç‚¹**ï¼š
  - `cerr` é»˜è®¤æ˜¯**ä¸ç¼“å†²**çš„ï¼Œè¿™æ„å‘³ç€å®ƒä¼šç«‹å³å°†å†…å®¹è¾“å‡ºåˆ°å±å¹•æˆ–æ–‡ä»¶ã€‚
  - ä¸€èˆ¬ç”¨äºç¨‹åºä¸­çš„é”™è¯¯æç¤ºæˆ–è­¦å‘Šä¿¡æ¯ã€‚
  - å¯ä»¥ç›´æ¥é€šè¿‡æµæ“ä½œç¬¦ï¼ˆå¦‚ `<<`ï¼‰è¾“å‡ºå†…å®¹ã€‚

**ç¤ºä¾‹**ï¼š

```
#include <iostream>
using namespace std;

int main() {
    cerr << "An error occurred!" << endl;
    return 0;
}
```

### 2. `perror`

- **ç±»å‹**ï¼š`perror` æ˜¯ C æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ã€‚
- **ç”¨é€”**ï¼šç”¨äºè¾“å‡ºä¸ `errno` ç›¸å…³çš„é”™è¯¯ä¿¡æ¯ã€‚`errno` æ˜¯ C æ ‡å‡†åº“æä¾›çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œè¡¨ç¤ºæœ€è¿‘ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨æˆ–åº“å‡½æ•°é”™è¯¯çš„é”™è¯¯ä»£ç ã€‚
- **ç‰¹ç‚¹**ï¼š
  - ä¼šè‡ªåŠ¨å°† `errno` ä¸­çš„é”™è¯¯ä»£ç è½¬åŒ–ä¸ºå¯è¯»çš„å­—ç¬¦ä¸²ï¼Œå¹¶è¾“å‡ºåˆ°æ ‡å‡†é”™è¯¯æµï¼ˆstderrï¼‰ã€‚
  - `perror` è¾“å‡ºçš„ä¿¡æ¯é€šå¸¸åŒ…æ‹¬ä¸€æ®µæè¿°é”™è¯¯çš„æ–‡æœ¬ï¼ˆé€šè¿‡ `strerror(errno)` è·å–ï¼‰å’Œé”™è¯¯åŸå› ã€‚
  - ä½¿ç”¨æ—¶å¯ä»¥åœ¨é”™è¯¯ä¿¡æ¯å‰åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„å­—ç¬¦ä¸²ã€‚

**ç¤ºä¾‹**ï¼š

```
#include <iostream>
#include <cerrno>
#include <cstring>
using namespace std;

int main() {
    FILE* file = fopen("nonexistent_file.txt", "r");
    if (!file) {
        perror("Error opening file");
    }
    return 0;
}
```

### 3. `strerror` 

- **ç±»å‹**ï¼š`strerror` æ˜¯ä¸€ä¸ª C æ ‡å‡†åº“å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªæè¿° `errno` é”™è¯¯ä»£ç çš„å­—ç¬¦ä¸²ã€‚

- **ç”¨é€”**ï¼šç”¨äºå°† `errno` ä¸­çš„é”™è¯¯ä»£ç è½¬æ¢ä¸ºä¸€ä¸ªäººç±»å¯è¯»çš„å­—ç¬¦ä¸²ã€‚

- **ç‰¹ç‚¹**ï¼š

  - å®ƒæ¥æ”¶ä¸€ä¸ª `errno` é”™è¯¯ç ï¼ˆé€šå¸¸æ˜¯ç³»ç»Ÿè°ƒç”¨æˆ–åº“å‡½æ•°è®¾ç½®çš„ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªæè¿°è¯¥é”™è¯¯çš„å­—ç¬¦ä¸²ã€‚
  - å¯ä»¥ç”¨æ¥æ‰‹åŠ¨æ ¼å¼åŒ–å’Œæ‰“å°é”™è¯¯ä¿¡æ¯ã€‚

  ```c++
  #include <iostream>
  #include <cerrno>
  #include <cstring> // For strerror
  
  int main() {
      FILE* file = fopen("nonexistent_file.txt", "r");
      if (!file) {
          std::cerr << "Error opening file: " << strerror(errno) << std::endl;
      }
      return 0;
  }
  
  ```

  ```c++
  #include <stdio.h>
  #include <errno.h>
  #include <string.h>
  
  int main() {
      // æ‰“å¼€ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶
      FILE *file = fopen("nonexistent_file.txt", "r");
  
      // å¦‚æœæ–‡ä»¶æ‰“å¼€å¤±è´¥ï¼Œfopen è¿”å› NULL
      if (file == NULL) {
          // ä½¿ç”¨ strerror è·å–é”™è¯¯æè¿°
          printf("Error opening file: %s\n", strerror(errno));
      }
  
      return 0;
  }
  
  ```

  

### `stderr`

- **ç±»å‹**ï¼š`stderr` æ˜¯ C å’Œ C++ æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªé¢„å®šä¹‰æ–‡ä»¶æŒ‡é’ˆï¼ŒæŒ‡å‘æ ‡å‡†é”™è¯¯è¾“å‡ºæµã€‚
- **ç”¨é€”**ï¼šé€šå¸¸ç”¨äºè¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚
- **ç‰¹ç‚¹**ï¼š
  - `stderr` æ˜¯ `FILE*` ç±»å‹ï¼Œå¯ä»¥é€šè¿‡ `fprintf` æˆ–ç±»ä¼¼çš„æ ‡å‡†åº“å‡½æ•°å°†é”™è¯¯ä¿¡æ¯è¾“å‡ºåˆ°æ ‡å‡†é”™è¯¯æµã€‚
  - ä¸ `stdout` ç±»ä¼¼ï¼Œ`stderr` å¯ä»¥é‡å®šå‘åˆ°æ–‡ä»¶æˆ–å…¶ä»–è¾“å‡ºæµä¸­ã€‚

**ç¤ºä¾‹**ï¼š

```
#include <cstdio>
using namespace std;

int main() {
    fprintf(stderr, "An error occurred!\n");
    return 0;
}
```

### strerror å’Œ stderræ··åˆ

å¤šç”¨äºçº¿ç¨‹

```c++
printf(stderr, â€œâ€¦%s\nâ€, strerror(ret))
```



### æ€»ç»“æ¯”è¾ƒï¼š

- **`cerr`**ï¼šæ˜¯ C++ ä¸­çš„æµå¯¹è±¡ï¼Œé€‚ç”¨äºæµå¼è¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚
- **`perror`**ï¼šæ˜¯ C å‡½æ•°ï¼Œä¸“é—¨ç”¨äºè¾“å‡ºä¸ `errno` ç›¸å…³çš„é”™è¯¯ä¿¡æ¯ï¼Œè‡ªåŠ¨æä¾›é”™è¯¯æè¿°ã€‚
- `strerror` æ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„å·¥å…·ï¼Œå…è®¸ä½ æ ¹æ® `errno` é”™è¯¯ç å¿«é€Ÿè·å–å’Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œé€šå¸¸ç”¨äºè°ƒè¯•æˆ–ç”¨æˆ·æç¤ºã€‚

ä½ å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©é€‚åˆçš„é”™è¯¯è¾“å‡ºæ–¹å¼ã€‚å¦‚æœä½ éœ€è¦æ˜¾ç¤ºä¸ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„é”™è¯¯ä¿¡æ¯ï¼Œ`perror` ä¼šæ›´æ–¹ä¾¿ï¼›å¦‚æœä½ å¸Œæœ›é€šè¿‡æµå¼æ“ä½œæ¥è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œ`cerr` ä¼šæ›´çµæ´»ï¼›



# æ·±å…¥ç†è§£ cerrã€perror å’Œ strerror

åœ¨ C/C++ ç¼–ç¨‹ä¸­ï¼Œé”™è¯¯å¤„ç†æ˜¯è‡³å…³é‡è¦çš„éƒ¨åˆ†ã€‚`cerr`ã€`perror` å’Œ `strerror` éƒ½æ˜¯ç”¨äºé”™è¯¯è¾“å‡ºçš„å·¥å…·ï¼Œä½†å®ƒä»¬æœ‰ä¸åŒçš„ç‰¹æ€§å’Œé€‚ç”¨åœºæ™¯ã€‚è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°æ¢è®¨å®ƒä»¬çš„åŒºåˆ«å’Œä½¿ç”¨æ–¹æ³•ã€‚

## 1. std::cerr (C++ æ ‡å‡†é”™è¯¯æµ)

**åŸºæœ¬ç‰¹æ€§ï¼š**

- å±äº C++ æ ‡å‡†åº“çš„ `<iostream>` å¤´æ–‡ä»¶
- æ˜¯ `std::ostream` ç±»çš„ä¸€ä¸ªå®ä¾‹
- é»˜è®¤å…³è”åˆ°æ ‡å‡†é”™è¯¯è®¾å¤‡ï¼ˆé€šå¸¸ä¸ stdout ç›¸åŒï¼Œä½†å¯å•ç‹¬é‡å®šå‘ï¼‰

**å…³é”®ç‰¹ç‚¹ï¼š**

- **æ— ç¼“å†²**ï¼šè¾“å‡ºç«‹å³åˆ·æ–°ï¼ˆä¸ clog ä¸åŒï¼Œåè€…æœ‰ç¼“å†²ï¼‰
- **çº¿ç¨‹å®‰å…¨**ï¼šC++11 èµ·ä¿è¯çº¿ç¨‹å®‰å…¨
- **å¯é‡å®šå‘**ï¼šå¯é‡å®šå‘åˆ°æ–‡ä»¶æˆ–å…¶ä»–æµ
- **ç±»å‹å®‰å…¨**ï¼šæ”¯æŒæ‰€æœ‰ C++ æµæ“ä½œ

**å…¸å‹ç”¨æ³•ï¼š**

```
#include <iostream>

int main() {
    std::cerr << "Error: Failed to open file!" << std::endl;
    return 1;
}
```

**é«˜çº§ç”¨æ³•ï¼š**

```
// é‡å®šå‘ cerr åˆ°æ–‡ä»¶
std::ofstream err_log("error.log");
std::streambuf* old_cerr = std::cerr.rdbuf(err_log.rdbuf());

// æ¢å¤åŸå§‹ cerr
std::cerr.rdbuf(old_cerr);
```

## 2. perror (C æ ‡å‡†åº“å‡½æ•°)

**åŸºæœ¬ç‰¹æ€§ï¼š**

- å£°æ˜äº `<cstdio>` (C++), `<stdio.h>` (C)
- åŸºäºå…¨å±€å˜é‡ `errno` è¾“å‡ºé”™è¯¯ä¿¡æ¯
- è‡ªåŠ¨è¿½åŠ å†’å·å’Œé”™è¯¯æè¿°

**å…³é”®ç‰¹ç‚¹ï¼š**

- **ç®€å•ç›´æ¥**ï¼šè‡ªåŠ¨å¤„ç† errno è½¬æ¢
- **æ ¼å¼å›ºå®š**ï¼šè¾“å‡ºæ ¼å¼ä¸º "è‡ªå®šä¹‰æ¶ˆæ¯: é”™è¯¯æè¿°"
- **éçº¿ç¨‹å®‰å…¨**ï¼šä¾èµ–å…¨å±€ errno å˜é‡

**å…¸å‹ç”¨æ³•ï¼š**

```
#include <cstdio>
#include <cerrno>

int main() {
    FILE* fp = fopen("nonexistent.txt", "r");
    if (!fp) {
        perror("Failed to open file");
        // è¾“å‡º: Failed to open file: No such file or directory
    }
    return 0;
}
```

**æ³¨æ„äº‹é¡¹ï¼š**

- æŸäº›å®ç°å¯èƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
- ä¼šä¿®æ”¹ errno çš„å€¼ï¼ˆæŸäº›å¹³å°ï¼‰
- åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­åº”è€ƒè™‘ä½¿ç”¨ strerror_r æ›¿ä»£

## 3. strerror/strerror_r (é”™è¯¯å·è½¬å­—ç¬¦ä¸²)

### strerror (éçº¿ç¨‹å®‰å…¨ç‰ˆæœ¬)

**åŸºæœ¬ç‰¹æ€§ï¼š**

- å£°æ˜äº `<cstring>` (C++), `<string.h>` (C)
- å°†é”™è¯¯å·è½¬æ¢ä¸ºå¯è¯»å­—ç¬¦ä¸²

**å…³é”®ç‰¹ç‚¹ï¼š**

- **è¿”å›é™æ€å†…å­˜**ï¼šæŸäº›å®ç°è¿”å›æŒ‡å‘é™æ€ç¼“å†²åŒºçš„æŒ‡é’ˆ
- **éçº¿ç¨‹å®‰å…¨**ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½æœ‰é—®é¢˜
- **ä¸ä¿®æ”¹ errno**ï¼šä¸ perror ä¸åŒ

**å…¸å‹ç”¨æ³•ï¼š**

```
#include <cstring>
#include <cerrno>
#include <iostream>

int main() {
    FILE* fp = fopen("nonexistent.txt", "r");
    if (!fp) {
        std::cerr << "Error: " << strerror(errno) << std::endl;
    }
    return 0;
}
```

### strerror_r (çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬)

**åŸºæœ¬ç‰¹æ€§ï¼š**

- XSI-compliant å’Œ GNU ä¸¤ç§ç‰ˆæœ¬
- éœ€è¦æä¾›ç¼“å†²åŒºå­˜å‚¨ç»“æœ

**å…¸å‹ç”¨æ³•ï¼š**

```
#include <cstring>
#include <cerrno>
#include <iostream>

int main() {
    char buf[256];
    FILE* fp = fopen("nonexistent.txt", "r");
    if (!fp) {
        strerror_r(errno, buf, sizeof(buf));
        std::cerr << "Error: " << buf << std::endl;
    }
    return 0;
}
```

## 4. stderr (C æ ‡å‡†é”™è¯¯æµ)

**åŸºæœ¬ç‰¹æ€§ï¼š**

- `FILE*` ç±»å‹çš„å…¨å±€å˜é‡
- é»˜è®¤è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œä½†å¯é‡å®šå‘

**å…¸å‹ç”¨æ³•ï¼š**

```
#include <cstdio>

int main() {
    fprintf(stderr, "Error occurred at line %d\n", __LINE__);
    return 1;
}
```

## å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§              | cerr             | perror       | strerror       | stderr         |
| :---------------- | :--------------- | :----------- | :------------- | :------------- |
| **è¯­è¨€**          | C++              | C            | C              | C              |
| **ç±»å‹**          | æµå¯¹è±¡           | å‡½æ•°         | å‡½æ•°           | æ–‡ä»¶æŒ‡é’ˆ       |
| **ç¼“å†²**          | æ— ç¼“å†²           | æ— ç¼“å†²       | ä¸é€‚ç”¨         | é€šå¸¸æ— ç¼“å†²     |
| **çº¿ç¨‹å®‰å…¨**      | C++11 èµ·æ˜¯       | é€šå¸¸ä¸æ˜¯     | strerror ä¸æ˜¯  | é€šå¸¸çº¿ç¨‹å®‰å…¨   |
| **è‡ªåŠ¨è§£é‡Šerrno** | å¦               | æ˜¯           | æ˜¯             | å¦             |
| **è¾“å‡ºç›®æ ‡**      | æ ‡å‡†é”™è¯¯         | æ ‡å‡†é”™è¯¯     | ä¸ç›´æ¥è¾“å‡º     | æ ‡å‡†é”™è¯¯       |
| **å…¸å‹ç”¨é€”**      | C++ ç¨‹åºé”™è¯¯è¾“å‡º | å¿«é€Ÿé”™è¯¯æŠ¥å‘Š | è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ | C é£æ ¼é”™è¯¯è¾“å‡º |

## æœ€ä½³å®è·µå»ºè®®

1. **C++ ç¨‹åºä¸­**ï¼šä¼˜å…ˆä½¿ç”¨ `cerr`ï¼Œå› ä¸ºå®ƒæ›´ç¬¦åˆ C++ é£æ ¼ï¼Œç±»å‹å®‰å…¨ä¸”å¯æ‰©å±•
2. **ç³»ç»Ÿè°ƒç”¨é”™è¯¯**ï¼šå½“éœ€è¦æ˜¾ç¤ºç³»ç»Ÿé”™è¯¯æ—¶ï¼Œ`perror` æœ€ç®€æ´
3. **è‡ªå®šä¹‰é”™è¯¯æ ¼å¼**ï¼šéœ€è¦çµæ´»æ ¼å¼åŒ–é”™è¯¯æ¶ˆæ¯æ—¶ï¼Œä½¿ç”¨ `strerror` æˆ– `strerror_r`
4. **å¤šçº¿ç¨‹ç¯å¢ƒ**ï¼šä½¿ç”¨ `strerror_r` æ›¿ä»£ `strerror` å’Œ `perror`
5. **æ€§èƒ½æ•æ„Ÿåœºæ™¯**ï¼šè€ƒè™‘ `stderr` æˆ– `fprintf(stderr)` å¯èƒ½æ¯” `cerr` æ›´é«˜æ•ˆ

## å®é™…åº”ç”¨ç¤ºä¾‹

```c++
#include <iostream>
#include <cstdio>
#include <cstring>
#include <cerrno>
#include <fstream>

void demonstrate_cerr() {
    std::cerr << "This is a C++ style error message" << std::endl;
}

void demonstrate_perror() {
    FILE* fp = fopen("nonexistent.txt", "r");
    if (!fp) {
        perror("perror example");
    }
}

void demonstrate_strerror() {
    FILE* fp = fopen("nonexistent.txt", "r");
    if (!fp) {
        std::cerr << "strerror example: " << strerror(errno) << std::endl;
    }
}

void demonstrate_stderr() {
    fprintf(stderr, "This is a C-style error to stderr\n");
}

int main() {
    demonstrate_cerr();
    demonstrate_perror();
    demonstrate_strerror();
    demonstrate_stderr();
    
    return 0;
}
```

ç†è§£è¿™äº›é”™è¯¯è¾“å‡ºå·¥å…·çš„åŒºåˆ«å’Œé€‚ç”¨åœºæ™¯ï¼Œå°†å¸®åŠ©ä½ ç¼–å†™æ›´å¥å£®ã€æ›´å¯ç»´æŠ¤çš„ä»£ç ï¼Œå¹¶èƒ½æ›´æœ‰æ•ˆåœ°å¤„ç†ç¨‹åºä¸­çš„é”™è¯¯æƒ…å†µã€‚



# cinåæ¸…ç©ºç¼“å†²åŒº

**ä¸ºä»€ä¹ˆä½¿ç”¨ `cin.get()` æ¸…ç©ºè¾“å…¥ç¼“å†²åŒºï¼Ÿ**

åœ¨ C++ ä¸­ï¼Œæ ‡å‡†è¾“å…¥æµï¼ˆ`cin`ï¼‰é€šå¸¸ä¼šç•™ä¸‹å¾ˆå¤šå­—ç¬¦åœ¨ç¼“å†²åŒºä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨è¯»å–æ•°æ®æ—¶ã€‚å¦‚æœä½ ä¹‹å‰ç”¨ `cin` è¯»å–äº†æŸäº›æ•°æ®ï¼ˆä¾‹å¦‚ä¸€ä¸ªæ•´æ•°æˆ–ä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰ï¼Œå¹¶ä¸”è¾“å…¥åæœ‰å¤šä½™çš„æ¢è¡Œç¬¦ï¼ˆ`'\n'`ï¼‰æˆ–ç©ºæ ¼å­—ç¬¦ï¼Œå®ƒä»¬å¯èƒ½ä¼šæ®‹ç•™åœ¨ç¼“å†²åŒºä¸­ï¼Œå½±å“åç»­çš„è¾“å…¥ã€‚



# `send()` å‘é€ `std::string` æ•°æ®çš„æ­£ç¡®æ–¹å¼

#### **1. æ ¸å¿ƒé—®é¢˜**

- **`send()` è¦æ±‚ `const void\*`ï¼ˆå­—èŠ‚æŒ‡é’ˆï¼‰**ï¼Œè€Œ `std::string` æ˜¯å¯¹è±¡ï¼Œä¸èƒ½ç›´æ¥è½¬æ¢ã€‚
- **å¿…é¡»ç”¨ `request.c_str()` æˆ– `request.data()` è·å–æŒ‡é’ˆ**ã€‚

#### **2. ä¸¤ç§å¸¸è§å†™æ³•å¯¹æ¯”**

| å†™æ³•                                                      | ç‰¹ç‚¹                                                         | é€‚ç”¨åœºæ™¯                      | æ½œåœ¨é—®é¢˜                                           |
| :-------------------------------------------------------- | :----------------------------------------------------------- | :---------------------------- | :------------------------------------------------- |
| `send(fd, request.c_str(), request.size(), 0)`            | âœ… **æ¨è** - å‘é€å®Œæ•´æ•°æ®ï¼ˆåŒ…æ‹¬ `\0` å¦‚æœå­˜åœ¨ï¼‰ - æ•ˆç‡é«˜ï¼ˆ`size()` æ˜¯ O(1)ï¼‰ | äºŒè¿›åˆ¶æ•°æ®æˆ–ä¸ç¡®å®šæ˜¯å¦å« `\0` | æ—                                                  |
| `send(fd, request.c_str(), strlen(request.c_str())+1, 0)` | âš ï¸ **è°¨æ…ä½¿ç”¨** - å¼ºåˆ¶ä»¥ `\0` ç»“å°¾ - å…¼å®¹ C é£æ ¼å­—ç¬¦ä¸²        | æ¥æ”¶æ–¹æ˜ç¡®è¦æ±‚ `\0` ç»“å°¾      | 1. ä¸­é—´ `\0` ä¼šæˆªæ–­æ•°æ® 2. `strlen()` æ˜¯ O(n) æ“ä½œ |

#### **3. å…³é”®ç»“è®º**

1. **ä¼˜å…ˆç”¨ `request.size()`**
   - ä¿è¯å‘é€å®Œæ•´æ•°æ®ï¼ˆå³ä½¿å« `\0`ï¼‰ï¼Œé€‚åˆç½‘ç»œåè®®æˆ–äºŒè¿›åˆ¶æ•°æ®ã€‚
   - ç¤ºä¾‹ï¼š`send(fd, request.data(), request.size(), 0)`
2. **æ…ç”¨ `strlen()+1`**
   - ä»…å½“æ¥æ”¶æ–¹**å¿…é¡»**ä»¥ `\0` ç»“å°¾æ—¶ä½¿ç”¨ï¼ˆå¦‚å…¼å®¹æ—§ C ä»£ç ï¼‰ã€‚
   - éœ€ç¡®ä¿å­—ç¬¦ä¸²æ— ä¸­é—´ `\0`ã€‚
3. **ä¸è¦ç›´æ¥ä¼  `request`**
   - ç¼–è¯‘é”™è¯¯ï¼š`std::string` ä¸èƒ½éšå¼è½¬æŒ‡é’ˆã€‚

#### **4. é™„åŠ å»ºè®®**

- **C++11 åŠä»¥ä¸Š**ï¼š`request.data()` å’Œ `request.c_str()` å®Œå…¨ç­‰ä»·ï¼Œä¼˜å…ˆç”¨ `data()`ï¼ˆè¯­ä¹‰æ›´æ˜ç¡®ï¼‰ã€‚
- **æ£€æŸ¥ `send()` è¿”å›å€¼**ï¼šå¤„ç†éƒ¨åˆ†å‘é€ï¼ˆ`len < request.size()`ï¼‰å’Œé”™è¯¯ï¼ˆ`len == -1`ï¼‰ã€‚
- **äºŒè¿›åˆ¶æ•°æ®**ï¼šé¿å…ä¾èµ– `\0`ï¼Œæ”¹ç”¨æ˜ç¡®é•¿åº¦å­—æ®µï¼ˆå¦‚åè®®å¤´ä¸­çš„ `Content-Length`ï¼‰ã€‚

#### **ä»£ç ç¤ºä¾‹å¯¹æ¯”**

cpp



å¤åˆ¶



ä¸‹è½½

```
// âœ… æ­£ç¡®ï¼šå‘é€å…¨éƒ¨æ•°æ®ï¼ˆæ¨èï¼‰
int len = send(fd, request.data(), request.size(), 0);

// âš ï¸ ç‰¹æ®Šæƒ…å†µï¼šå¼ºåˆ¶å‘é€ \0 ç»“å°¾ï¼ˆéœ€ç¡®ä¿æ— ä¸­é—´ \0ï¼‰
int len = send(fd, request.c_str(), strlen(request.c_str()) + 1, 0);

// âŒ é”™è¯¯ï¼šä¸èƒ½ç›´æ¥ä¼  std::string
int len = send(fd, request, request.size(), 0);  // ç¼–è¯‘å¤±è´¥ï¼
```

#### **ä¸€å¥è¯æ€»ç»“**

**ç”¨ `request.data()` + `request.size()` å‘é€å®Œæ•´æ•°æ®ï¼›ä»…åœ¨æ¥æ”¶æ–¹è¦æ±‚ `\0` æ—¶ç”¨ `strlen()+1`ï¼Œå¹¶ç¡®ä¿æ— æ•°æ®æˆªæ–­ã€‚**



# C++11 å¤šçº¿ç¨‹ç¼–ç¨‹ (`std::thread`)

C++11 å¼•å…¥äº† `<thread>` å¤´æ–‡ä»¶ï¼Œæä¾›äº† `std::thread` ç±»æ¥æ”¯æŒå¤šçº¿ç¨‹ç¼–ç¨‹ã€‚ä»¥ä¸‹æ˜¯å…³äº C++11 çº¿ç¨‹çš„å…¨é¢æ€»ç»“ï¼š

**é‡ç‚¹æ˜¯ thread æ”¯æŒè·¨å¹³å°, ä¸åŒçš„å¹³å° é‡Œé¢ä½¿ç”¨ä¸åŒç³»ç»Ÿè°ƒç”¨**

## 1. åŸºæœ¬ç”¨æ³•

### åˆ›å»ºçº¿ç¨‹

```
#include <iostream>
#include <thread>

void hello() {
    std::cout << "Hello from thread!\n";
}

int main() {
    std::thread t(hello);  // åˆ›å»ºçº¿ç¨‹å¹¶æ‰§è¡Œhelloå‡½æ•°
    t.join();             // ç­‰å¾…çº¿ç¨‹ç»“æŸ
    return 0;
}
```

### å¸¦å‚æ•°çš„çº¿ç¨‹å‡½æ•°

```
void print_num(int num) {
    std::cout << "Number: " << num << "\n";
}

int main() {
    std::thread t(print_num, 42);  // ä¼ é€’å‚æ•°42
    t.join();
}
```

## 2. çº¿ç¨‹ç®¡ç†

### join() å’Œ detach()

- `join()`: ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
- `detach()`: åˆ†ç¦»çº¿ç¨‹ï¼Œä½¿å…¶ç‹¬ç«‹è¿è¡Œ



```
std::thread t(do_work);

t.join();   // ç­‰å¾…tå®Œæˆ
// æˆ–
t.detach(); // è®©tåœ¨åå°è¿è¡Œ
```

### æ£€æŸ¥çº¿ç¨‹æ˜¯å¦å¯join

```
if (t.joinable()) {
    t.join();
}
```

## 3. çº¿ç¨‹ä¼ é€’å¼•ç”¨

é»˜è®¤æƒ…å†µä¸‹å‚æ•°æ˜¯æŒ‰å€¼ä¼ é€’çš„ï¼Œè¦ä¼ é€’å¼•ç”¨éœ€è¦ä½¿ç”¨ `std::ref`:

```
void modify(int& x) {
    x = 2;
}

int main() {
    int x = 1;
    std::thread t(modify, std::ref(x));
    t.join();
    std::cout << x;  // è¾“å‡º2
}
```

## 4. çº¿ç¨‹ä¸ç±»çš„æˆå‘˜å‡½æ•°

```
class Worker {
public:
    void do_work() {
        std::cout << "Working...\n";
    }
};

int main() {
    Worker worker;
    std::thread t(&Worker::do_work, &worker);
    t.join();
}
```

## 5. çº¿ç¨‹åŒæ­¥æœºåˆ¶

### mutex (äº’æ–¥é”)

```
#include <mutex>

std::mutex mtx;

void safe_print(const std::string& msg) {
    mtx.lock();
    std::cout << msg << "\n";
    mtx.unlock();
}
```

### lock_guard (RAIIé£æ ¼çš„é”)

```
void safer_print(const std::string& msg) {
    std::lock_guard<std::mutex> lock(mtx);
    std::cout << msg << "\n";
    // ç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨è§£é”
}
```

### unique_lock (æ›´çµæ´»çš„é”)

```
void flexible_print(const std::string& msg) {
    std::unique_lock<std::mutex> lock(mtx, std::defer_lock);
    // åšä¸€äº›ä¸æ¶‰åŠå…±äº«èµ„æºçš„æ“ä½œ...
    lock.lock();
    std::cout << msg << "\n";
    // å¯ä»¥æ‰‹åŠ¨è§£é”
    lock.unlock();
}
```

## 6. æ¡ä»¶å˜é‡ (condition_variable)

```
#include <condition_variable>

std::mutex mtx;
std::condition_variable cv;
bool ready = false;

void worker() {
    std::unique_lock<std::mutex> lock(mtx);
    cv.wait(lock, []{return ready;});
    std::cout << "Worker is working\n";
}

int main() {
    std::thread t(worker);
    
    {
        std::lock_guard<std::mutex> lock(mtx);
        ready = true;
    }
    cv.notify_one();
    
    t.join();
}
```

## 7. çº¿ç¨‹å±€éƒ¨å­˜å‚¨ (thread_local)

```
thread_local int counter = 0;  // æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„å‰¯æœ¬

void increment() {
    ++counter;
    std::cout << "Counter: " << counter << "\n";
}

int main() {
    std::thread t1(increment);
    std::thread t2(increment);
    
    t1.join();
    t2.join();
    // è¾“å‡ºå¯èƒ½æ˜¯:
    // Counter: 1
    // Counter: 1
}
```

## 8. å¼‚æ­¥æ“ä½œ (async/future)

```
#include <future>

int compute() {
    // æ¨¡æ‹Ÿè€—æ—¶è®¡ç®—
    std::this_thread::sleep_for(std::chrono::seconds(1));
    return 42;
}

int main() {
    std::future<int> result = std::async(std::launch::async, compute);
    
    // å¯ä»¥åšå…¶ä»–äº‹æƒ…...
    
    std::cout << "Result: " << result.get() << "\n";  // é˜»å¡ç›´åˆ°ç»“æœå¯ç”¨
}
```

## 9. çº¿ç¨‹æ± æ¨¡å¼

C++11æ²¡æœ‰å†…ç½®çº¿ç¨‹æ± ï¼Œä½†å¯ä»¥è‡ªå·±å®ç°ï¼š

```
class ThreadPool {
    std::vector<std::thread> workers;
    std::queue<std::function<void()>> tasks;
    std::mutex queue_mutex;
    std::condition_variable condition;
    bool stop = false;
    
public:
    ThreadPool(size_t threads) {
        for(size_t i = 0; i < threads; ++i) {
            workers.emplace_back([this] {
                while(true) {
                    std::function<void()> task;
                    {
                        std::unique_lock<std::mutex> lock(this->queue_mutex);
                        this->condition.wait(lock,
                            [this]{ return this->stop || !this->tasks.empty(); });
                        if(this->stop && this->tasks.empty())
                            return;
                        task = std::move(this->tasks.front());
                        this->tasks.pop();
                    }
                    task();
                }
            });
        }
    }
    
    template<class F>
    void enqueue(F&& f) {
        {
            std::unique_lock<std::mutex> lock(queue_mutex);
            tasks.emplace(std::forward<F>(f));
        }
        condition.notify_one();
    }
    
    ~ThreadPool() {
        {
            std::unique_lock<std::mutex> lock(queue_mutex);
            stop = true;
        }
        condition.notify_all();
        for(std::thread &worker: workers)
            worker.join();
    }
};
```

## 10. æ³¨æ„äº‹é¡¹

1. **ä¸è¦å¿˜è®°joinæˆ–detach** - æœªjoinæˆ–detachçš„çº¿ç¨‹åœ¨ææ„æ—¶ä¼šè°ƒç”¨std::terminate
2. **é¿å…æ•°æ®ç«äº‰** - ä½¿ç”¨é€‚å½“çš„åŒæ­¥æœºåˆ¶
3. **æ³¨æ„å¼‚å¸¸å®‰å…¨** - çº¿ç¨‹ä¸­çš„å¼‚å¸¸ä¸ä¼šè‡ªåŠ¨ä¼ æ’­åˆ°ä¸»çº¿ç¨‹
4. **é¿å…æ­»é”** - å°å¿ƒé”çš„è·å–é¡ºåº
5. **è€ƒè™‘æ€§èƒ½** - çº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢æœ‰å¼€é”€

C++11çš„çº¿ç¨‹åº“æä¾›äº†**è·¨å¹³å°çš„å¤šçº¿ç¨‹æ”¯æŒ**ï¼Œæ¯”å¹³å°ç‰¹å®šçš„API(å¦‚pthread)æ›´æ˜“äºä½¿ç”¨ã€‚å¯¹äºæ›´é«˜çº§çš„å¹¶å‘éœ€æ±‚ï¼Œè¿˜å¯ä»¥è€ƒè™‘C++17å’ŒC++20å¼•å…¥çš„å¹¶è¡Œç®—æ³•å’Œå…¶ä»–å¹¶å‘ç‰¹æ€§ã€‚

## 11.è·¨å¹³å°

C++11 å¼•å…¥çš„ `<thread>` åº“ç¡®å®æä¾›äº†è·¨å¹³å°çš„å¤šçº¿ç¨‹æ”¯æŒï¼Œå°†ä¸åŒæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ APIï¼ˆå¦‚ Windows çš„ `CreateThread` å’Œ Linux çš„ `pthread`ï¼‰ç»Ÿä¸€å°è£…ï¼Œè®©å¼€å‘è€…å¯ä»¥ç¼–å†™å¯ç§»æ¤çš„å¤šçº¿ç¨‹ä»£ç ã€‚



# å˜é‡ç±»å‹

### 1. **å±€éƒ¨å˜é‡ (Local Variable)**

å±€éƒ¨å˜é‡æ˜¯åœ¨å‡½æ•°æˆ–ä»£ç å—å†…éƒ¨å£°æ˜çš„å˜é‡ï¼Œå®ƒä»¬çš„ä½œç”¨èŒƒå›´å’Œç”Ÿå‘½å‘¨æœŸéƒ½é™åˆ¶åœ¨è¯¥å‡½æ•°æˆ–ä»£ç å—å†…ã€‚

- **ä½œç”¨åŸŸ**ï¼šä»…åœ¨å‡½æ•°æˆ–ä»£ç å—å†…æœ‰æ•ˆã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šåœ¨å‡½æ•°è°ƒç”¨æ—¶åˆ›å»ºï¼Œå‡½æ•°ç»“æŸæ—¶é”€æ¯ã€‚
- **åˆå§‹åŒ–**ï¼šå¦‚æœæ²¡æœ‰æ˜¾å¼åˆå§‹åŒ–ï¼Œå®ƒä»¬çš„å€¼æ˜¯æœªå®šä¹‰çš„ï¼ˆå³åƒåœ¾å€¼ï¼‰ã€‚

#### ç¤ºä¾‹ï¼š

```
void func() {
    int a = 10;  // å±€éƒ¨å˜é‡
    std::cout << a << std::endl;
}
```

------

### 2. **é™æ€å±€éƒ¨å˜é‡ (Static Local Variable)**

é™æ€å±€éƒ¨å˜é‡æ˜¯ä½¿ç”¨ `static` å…³é”®å­—å£°æ˜çš„å±€éƒ¨å˜é‡ï¼Œå®ƒçš„ä½œç”¨åŸŸä»ç„¶ä»…é™äºå‡½æ•°å†…ï¼Œä½†ç”Ÿå‘½å‘¨æœŸæŒç»­æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸã€‚

- **ä½œç”¨åŸŸ**ï¼šä»…åœ¨å‡½æ•°å†…éƒ¨æœ‰æ•ˆã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šç¨‹åºè¿è¡ŒæœŸé—´æœ‰æ•ˆï¼Œå‡½æ•°é€€å‡ºåä»ç„¶å­˜åœ¨ï¼Œä¿ç•™ä¸Šæ¬¡è°ƒç”¨çš„å€¼ã€‚
- **åˆå§‹åŒ–**ï¼šåˆå§‹åŒ–åªå‘ç”Ÿä¸€æ¬¡ï¼Œè‹¥æœªæ˜¾å¼åˆå§‹åŒ–ï¼Œé»˜è®¤ä¸ºé›¶ã€‚

#### ç¤ºä¾‹ï¼š

```
void func() {
    static int counter = 0;  // é™æ€å±€éƒ¨å˜é‡
    counter++;
    std::cout << counter << std::endl;
}
```

------

### 3. **å…¨å±€å˜é‡ (Global Variable)**

å…¨å±€å˜é‡åœ¨æ‰€æœ‰å‡½æ•°å¤–éƒ¨å£°æ˜ï¼Œå¹¶å¯ä»¥åœ¨æ•´ä¸ªç¨‹åºä¸­è®¿é—®ã€‚

- **ä½œç”¨åŸŸ**ï¼šç¨‹åºä¸­æ‰€æœ‰å‡½æ•°éƒ½å¯ä»¥è®¿é—®ã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šç¨‹åºè¿è¡ŒæœŸé—´æœ‰æ•ˆï¼Œç›´åˆ°ç¨‹åºç»“æŸæ—¶æ‰é”€æ¯ã€‚
- **åˆå§‹åŒ–**ï¼šå…¨å±€å˜é‡å¦‚æœæ²¡æœ‰æ˜¾å¼åˆå§‹åŒ–ï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶è‡ªåŠ¨åˆå§‹åŒ–ä¸ºé›¶ã€‚

#### ç¤ºä¾‹ï¼š

```
int global_var = 0;  // å…¨å±€å˜é‡

void func() {
    global_var++;
    std::cout << global_var << std::endl;
}
```

------

### 4. **å¸¸é‡å˜é‡ (Constant Variable)**

å¸¸é‡å˜é‡ä½¿ç”¨ `const` å…³é”®å­—å£°æ˜ï¼Œåœ¨åˆå§‹åŒ–åä¸å¯ä¿®æ”¹ã€‚

- **ä½œç”¨åŸŸ**ï¼šå–å†³äºå£°æ˜çš„ä½ç½®ï¼Œå¯ä»¥æ˜¯å±€éƒ¨çš„ã€é™æ€çš„æˆ–å…¨å±€çš„ã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šä¸æ™®é€šå˜é‡ç›¸åŒï¼Œä½†å…¶å€¼ä¸å¯æ”¹å˜ã€‚
- **åˆå§‹åŒ–**ï¼šå¿…é¡»åœ¨å£°æ˜æ—¶åˆå§‹åŒ–ã€‚

#### ç¤ºä¾‹ï¼š

```
cpp


å¤åˆ¶ç¼–è¾‘
const int MAX_VALUE = 100;  // å¸¸é‡å˜é‡
```

------

### 5. **çº¿ç¨‹å±€éƒ¨å˜é‡ (Thread-Local Variable)**

çº¿ç¨‹å±€éƒ¨å˜é‡ä½¿ç”¨ `thread_local` å…³é”®å­—å£°æ˜ï¼Œè¡¨ç¤ºæ¯ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚

- **ä½œç”¨åŸŸ**ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šæ¯ä¸ªçº¿ç¨‹ç»“æŸæ—¶é”€æ¯çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚
- **åˆå§‹åŒ–**ï¼šçº¿ç¨‹å±€éƒ¨å˜é‡åˆå§‹åŒ–è¡Œä¸ºä¸æ™®é€šå±€éƒ¨å˜é‡ç›¸ä¼¼ã€‚

#### ç¤ºä¾‹ï¼š

```
cpp


å¤åˆ¶ç¼–è¾‘
thread_local int thread_local_var = 0;  // çº¿ç¨‹å±€éƒ¨å˜é‡
```

------

### 6. **é™æ€å…¨å±€å˜é‡ (Static Global Variable)**

é™æ€å…¨å±€å˜é‡ä½¿ç”¨ `static` å…³é”®å­—å£°æ˜ï¼Œè¡¨ç¤ºå®ƒä»…åœ¨å®šä¹‰å®ƒçš„æ–‡ä»¶å†…æœ‰æ•ˆï¼Œå…¶ä»–æ–‡ä»¶æ— æ³•è®¿é—®ã€‚

- **ä½œç”¨åŸŸ**ï¼šä»…é™äºå£°æ˜å®ƒçš„æ–‡ä»¶ã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šç¨‹åºè¿è¡ŒæœŸé—´æœ‰æ•ˆï¼Œç›´åˆ°ç¨‹åºç»“æŸã€‚
- **åˆå§‹åŒ–**ï¼šä¸æ™®é€šå…¨å±€å˜é‡ç›¸åŒï¼Œæœªåˆå§‹åŒ–æ—¶é»˜è®¤ä¸ºé›¶ã€‚

#### ç¤ºä¾‹ï¼š

```
cpp


å¤åˆ¶ç¼–è¾‘
static int file_local_var = 0;  // é™æ€å…¨å±€å˜é‡ï¼Œåªèƒ½åœ¨å½“å‰æ–‡ä»¶è®¿é—®
```

------

### 7. **åŠ¨æ€å†…å­˜åˆ†é…å˜é‡ (Dynamic Memory Variable)**

åŠ¨æ€å†…å­˜å˜é‡æ˜¯é€šè¿‡ `malloc`ï¼ˆCï¼‰æˆ– `new`ï¼ˆC++ï¼‰ç­‰æ–¹æ³•åˆ†é…çš„å˜é‡ï¼Œå®ƒä»¬çš„å†…å­˜ä½ç½®åœ¨å †ä¸Šï¼Œç”Ÿå‘½å‘¨æœŸç”±ç¨‹åºå‘˜æ‰‹åŠ¨ç®¡ç†ã€‚

- **ä½œç”¨åŸŸ**ï¼šæŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å­˜å—åœ¨å †ä¸­ï¼Œç›´åˆ°æ‰‹åŠ¨é‡Šæ”¾ã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šç”±ç¨‹åºå‘˜æ˜¾å¼ç®¡ç†ï¼Œé€šå¸¸åœ¨ä½¿ç”¨å®Œæ¯•åé€šè¿‡ `free`ï¼ˆCï¼‰æˆ– `delete`ï¼ˆC++ï¼‰é‡Šæ”¾ã€‚
- **åˆå§‹åŒ–**ï¼šéœ€è¦æ‰‹åŠ¨åˆ†é…å’Œåˆå§‹åŒ–å†…å­˜ã€‚

#### ç¤ºä¾‹ï¼š

```
int* ptr = new int(10);  // åŠ¨æ€åˆ†é…çš„å†…å­˜
delete ptr;  // é‡Šæ”¾å†…å­˜
```

------

### 8. **è‡ªåŠ¨å˜é‡ (Automatic Variable)**

è‡ªåŠ¨å˜é‡æ˜¯é»˜è®¤å£°æ˜çš„å˜é‡ï¼Œé€šå¸¸æŒ‡æ™®é€šçš„å±€éƒ¨å˜é‡ã€‚`auto` æ˜¯é»˜è®¤ç±»å‹æ¨å¯¼å…³é”®å­—ï¼Œå…è®¸ç¼–è¯‘å™¨æ ¹æ®åˆå§‹åŒ–å€¼æ¨æ–­å˜é‡çš„ç±»å‹ã€‚

- **ä½œç”¨åŸŸ**ï¼šé€šå¸¸æ˜¯å‡½æ•°æˆ–ä»£ç å—çš„ä½œç”¨åŸŸã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šå‡½æ•°æˆ–ä»£ç å—æ‰§è¡Œæ—¶åˆ›å»ºï¼Œæ‰§è¡Œç»“æŸæ—¶é”€æ¯ã€‚
- **åˆå§‹åŒ–**ï¼šå¿…é¡»æ˜¾å¼åˆå§‹åŒ–ã€‚

#### ç¤ºä¾‹ï¼š

```
cpp


å¤åˆ¶ç¼–è¾‘
auto x = 10;  // è‡ªåŠ¨ç±»å‹æ¨å¯¼å˜é‡
```

------

### 9. **å¯„å­˜å™¨å˜é‡ (Register Variable)**

å¯„å­˜å™¨å˜é‡æ˜¯é€šè¿‡ `register` å…³é”®å­—å£°æ˜çš„ï¼ŒæŒ‡ç¤ºç¼–è¯‘å™¨å°½é‡å°†å˜é‡å­˜å‚¨åœ¨ CPU å¯„å­˜å™¨ä¸­ï¼Œä»¥æé«˜è®¿é—®é€Ÿåº¦ã€‚

- **ä½œç”¨åŸŸ**ï¼šä¸å±€éƒ¨å˜é‡ç›¸åŒã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šä¸å±€éƒ¨å˜é‡ç›¸åŒã€‚
- **åˆå§‹åŒ–**ï¼šå¯„å­˜å™¨å˜é‡å¯ä»¥åœ¨å£°æ˜æ—¶åˆå§‹åŒ–ï¼Œä½†ä¸èƒ½è·å–å…¶åœ°å€ï¼ˆä¸å…è®¸å–åœ°å€æ“ä½œï¼‰ã€‚

#### ç¤ºä¾‹ï¼š

```
cpp


å¤åˆ¶ç¼–è¾‘
register int count = 0;  // å¯„å­˜å™¨å˜é‡
```

------

### 10. **å¤–éƒ¨å˜é‡ (External Variable)**

å¤–éƒ¨å˜é‡ä½¿ç”¨ `extern` å…³é”®å­—å£°æ˜ï¼Œç”¨äºåœ¨å¤šä¸ªæºæ–‡ä»¶ä¸­å…±äº«ä¸€ä¸ªå…¨å±€å˜é‡ã€‚å®ƒå‘Šè¯‰ç¼–è¯‘å™¨è¿™ä¸ªå˜é‡åœ¨å…¶ä»–åœ°æ–¹å®šä¹‰ã€‚

- **ä½œç”¨åŸŸ**ï¼šè·¨æ–‡ä»¶å¯è®¿é—®ã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šç¨‹åºè¿è¡ŒæœŸé—´æœ‰æ•ˆï¼Œç›´åˆ°ç¨‹åºç»“æŸæ—¶é”€æ¯ã€‚
- **åˆå§‹åŒ–**ï¼šå¤–éƒ¨å˜é‡å¿…é¡»åœ¨æŸä¸ªæºæ–‡ä»¶ä¸­å®šä¹‰ï¼Œå¦åˆ™ä¼šå¯¼è‡´é“¾æ¥é”™è¯¯ã€‚

#### ç¤ºä¾‹ï¼š

```
// file1.cpp
int external_var = 10;

// file2.cpp
extern int external_var;  // å¼•ç”¨å¤–éƒ¨å˜é‡
```

------

### 11. **é™æ€å˜é‡ (Static Variable)**

é™æ€å˜é‡ï¼ˆä¸è®ºæ˜¯å±€éƒ¨è¿˜æ˜¯å…¨å±€ï¼‰ä½¿ç”¨ `static` å…³é”®å­—å£°æ˜ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä»ç¨‹åºå¼€å§‹ç›´åˆ°ç¨‹åºç»“æŸï¼Œä½œç”¨åŸŸæ ¹æ®å®ƒæ˜¯å±€éƒ¨è¿˜æ˜¯å…¨å±€å˜é‡æ¥å®šã€‚

- **ä½œç”¨åŸŸ**ï¼šå±€éƒ¨é™æ€å˜é‡ä»…é™äºå‡½æ•°å†…ï¼Œå…¨å±€é™æ€å˜é‡ä»…é™äºæ–‡ä»¶å†…ã€‚
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šç¨‹åºè¿è¡ŒæœŸé—´å§‹ç»ˆå­˜åœ¨ã€‚
- **åˆå§‹åŒ–**ï¼šé™æ€å˜é‡åˆå§‹åŒ–åªä¼šå‘ç”Ÿä¸€æ¬¡ï¼Œæœªåˆå§‹åŒ–æ—¶é»˜è®¤ä¸ºé›¶ã€‚

#### ç¤ºä¾‹ï¼š

```
cpp


å¤åˆ¶ç¼–è¾‘
static int static_var = 0;  // é™æ€å±€éƒ¨å˜é‡
```

------

### 12. **å¸¸é‡æŒ‡é’ˆå’ŒæŒ‡é’ˆå¸¸é‡**

- **å¸¸é‡æŒ‡é’ˆ**ï¼šæŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆï¼Œä¸èƒ½ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œä½†å¯ä»¥æ”¹å˜æŒ‡é’ˆæœ¬èº«ã€‚

  ```
  cpp
  
  
  å¤åˆ¶ç¼–è¾‘
  const int* ptr = &var;
  ```

- **æŒ‡é’ˆå¸¸é‡**ï¼šæŒ‡é’ˆæœ¬èº«æ˜¯å¸¸é‡ï¼Œä¸èƒ½æŒ‡å‘åˆ«çš„åœ°å€ï¼Œä½†å¯ä»¥ä¿®æ”¹æŒ‡å‘çš„å†…å®¹ã€‚

  ```
  cpp
  
  
  å¤åˆ¶ç¼–è¾‘
  int* const ptr = &var;
  ```

- **å¸¸é‡æŒ‡é’ˆå¸¸é‡**ï¼šæŒ‡é’ˆæœ¬èº«å’ŒæŒ‡å‘çš„å†…å®¹éƒ½ä¸èƒ½æ”¹å˜ã€‚

  ```
  cpp
  
  
  å¤åˆ¶ç¼–è¾‘
  const int* const ptr = &var;
  ```

------

### æ€»ç»“



| ç±»å‹                 | ä½œç”¨åŸŸ                       | ç”Ÿå‘½å‘¨æœŸ                       | åˆå§‹åŒ–                               |
| -------------------- | ---------------------------- | ------------------------------ | ------------------------------------ |
| **å±€éƒ¨å˜é‡**         | å‡½æ•°æˆ–ä»£ç å—å†…éƒ¨             | å‡½æ•°è°ƒç”¨æ—¶åˆ›å»ºï¼Œç»“æŸæ—¶é”€æ¯     | é»˜è®¤æœªåˆå§‹åŒ–ï¼Œå¯èƒ½æœ‰åƒåœ¾å€¼           |
| **é™æ€å±€éƒ¨å˜é‡**     | å‡½æ•°å†…éƒ¨                     | ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œå‡½æ•°è°ƒç”¨é—´ä¿ç•™å€¼ | åˆå§‹åŒ–ä¸€æ¬¡ï¼Œæœªæ˜¾å¼åˆå§‹åŒ–é»˜è®¤é›¶       |
| **å…¨å±€å˜é‡**         | ç¨‹åºä¸­æ‰€æœ‰å‡½æ•°éƒ½èƒ½è®¿é—®       | ç¨‹åºè¿è¡ŒæœŸé—´æœ‰æ•ˆ               | æœªåˆå§‹åŒ–æ—¶é»˜è®¤é›¶                     |
| **å¸¸é‡å˜é‡**         | å±€éƒ¨ã€é™æ€æˆ–å…¨å±€             | ä¸æ™®é€šå˜é‡ç›¸åŒ                 | å¿…é¡»åˆå§‹åŒ–                           |
| **çº¿ç¨‹å±€éƒ¨å˜é‡**     | æ¯ä¸ªçº¿ç¨‹çš„ç‹¬ç«‹å‰¯æœ¬           | æ¯ä¸ªçº¿ç¨‹ç»“æŸæ—¶é”€æ¯             | ä¸æ™®é€šå˜é‡ç›¸åŒ                       |
| **é™æ€å…¨å±€å˜é‡**     | æ–‡ä»¶å†…éƒ¨                     | ç¨‹åºè¿è¡ŒæœŸé—´æœ‰æ•ˆ               | æœªåˆå§‹åŒ–æ—¶é»˜è®¤é›¶                     |
| **åŠ¨æ€å†…å­˜åˆ†é…å˜é‡** | å †å†…å­˜                       | æ‰‹åŠ¨ç®¡ç†                       | éœ€è¦æ‰‹åŠ¨åˆ†é…å’Œåˆå§‹åŒ–                 |
| **è‡ªåŠ¨å˜é‡**         | é€šå¸¸å±€éƒ¨ä½œç”¨åŸŸ               | ä¸å±€éƒ¨å˜é‡ç›¸åŒ                 | å¿…é¡»åˆå§‹åŒ–                           |
| **å¯„å­˜å™¨å˜é‡**       | ä¸å±€éƒ¨å˜é‡ç›¸åŒ               | ä¸å±€éƒ¨å˜é‡ç›¸åŒ                 | ä¸èƒ½å–åœ°å€æ“ä½œ                       |
| **å¤–éƒ¨å˜é‡**         | è·¨æ–‡ä»¶è®¿é—®                   | ç¨‹åºè¿è¡ŒæœŸé—´æœ‰æ•ˆ               | åœ¨æŸä¸ªæºæ–‡ä»¶ä¸­å®šä¹‰                   |
| **é™æ€å˜é‡**         | å±€éƒ¨æˆ–å…¨å±€ï¼Œä¾èµ–äºé™æ€å…³é”®å­— | ç¨‹åºè¿è¡ŒæœŸé—´æœ‰æ•ˆ               | é™æ€å˜é‡åˆå§‹åŒ–ä¸€æ¬¡ï¼Œæœªåˆå§‹åŒ–æ—¶é»˜è®¤é›¶ |

è¿™äº›å°±æ˜¯ C/C++ ä¸­çš„ä¸»è¦å˜é‡ç±»å‹åŠå…¶ç‰¹æ€§ï¼Œå¸Œæœ›è¿™ä¸ªå…¨é¢çš„æ€»ç»“èƒ½å¸®åŠ©ä½ ç†è§£æ¯ç§å˜é‡çš„ç”¨é€”å’ŒåŒºåˆ«ã€‚å¦‚æœæœ‰æ›´ç»†èŠ‚çš„é—®é¢˜æˆ–å…¶ä»–ç–‘é—®ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼



# åŸå­ç±»å‹

**åŸå­ç±»å‹ï¼ˆAtomic Typesï¼‰**ï¼Œå°±æ˜¯é‚£ç§**åœ¨å¤šçº¿ç¨‹ç¨‹åºé‡Œæ“ä½œæ—¶ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰“æ–­çš„å˜é‡ç±»å‹**ã€‚

> åŸºäºCASå®ç°



æ¢å¥è¯è¯´ï¼š
 ğŸ‘‰ **åŸå­ç±»å‹çš„è¯»å†™æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œè¦ä¹ˆå®Œæˆäº†ï¼Œè¦ä¹ˆæ²¡åšï¼Œä¸ä¼šä¸­é€”è¢«æŠ¢èµ°ã€‚**

ä» C++11 å¼€å§‹ï¼Œæ ‡å‡†åº“å°±æœ‰åŸå­ç±»å‹äº†ï¼Œå« `<atomic>`ï¼Œç”¨èµ·æ¥è¶…ç®€å•ï¼š

```
#include <atomic>

std::atomic<int> counter(0);

void thread_func() {
    counter++;
}
```

è¿™é‡Œçš„ `counter++` æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼å¤šä¸ªçº¿ç¨‹åŒæ—¶åŠ ä¹Ÿä¸ä¼šå†²çªã€‚

è¿˜æœ‰ `atomic_bool` ç­‰ç±»å‹

| æ“ä½œ                           | è¯´æ˜              |
| :----------------------------- | :---------------- |
| load()                         | è¯»å–å€¼            |
| store()                        | å†™å…¥å€¼            |
| fetch_add(x)                   | åŠ ä¸Š x å¹¶è¿”å›æ—§å€¼ |
| fetch_sub(x)                   | å‡å» x å¹¶è¿”å›æ—§å€¼ |
| compare_exchange_weak / strong | CASï¼ˆæ¯”è¾ƒå¹¶äº¤æ¢ï¼‰ |



## CAS æ€»ç»“

- **CAS**ï¼ˆCompare and Swapï¼‰= æ¯”è¾ƒå¹¶äº¤æ¢ã€‚

- åŸå­æ“ä½œï¼š**å¦‚æœå½“å‰å€¼ == é¢„æœŸå€¼ï¼Œå°±å†™æ–°å€¼ï¼Œå¦åˆ™å¤±è´¥**ã€‚

- ç‰¹ç‚¹ï¼š

  - **æ— é”**ï¼Œéå¸¸å¿«ã€‚
  - CPU åŸç”Ÿæ”¯æŒï¼ˆæŒ‡ä»¤çº§ï¼‰ã€‚

- C++ ç”¨æ³•ï¼š

  ```
  std::atomic<int> a;
  a.compare_exchange_strong(expected, desired);
  ```

- å¸¸è§é—®é¢˜ï¼š

  - **ABAé—®é¢˜**ï¼šå€¼å˜äº†åˆå˜å›å»ï¼ŒCASçœ‹ä¸å‡ºæ¥ã€‚ï¼ˆå¯åŠ ç‰ˆæœ¬å·è§£å†³ï¼‰
  - **è‡ªæ—‹å¼€é”€**ï¼šç«äº‰ä¸¥é‡æ—¶ä¸€ç›´é‡è¯•ï¼Œæµªè´¹CPUã€‚

------

## åŸå­ç±»å‹æ€»ç»“

- åŸå­ç±»å‹ = **çº¿ç¨‹å®‰å…¨çš„è½»é‡å˜é‡**ã€‚
- ä¿è¯è¯»å†™æ“ä½œ**ä¸å¯è¢«æ‰“æ–­**ã€‚
- å¸¸ç”¨æ“ä½œï¼š
  - `load()` è¯»å–
  - `store()` å†™å…¥
  - `fetch_add()` åŠ 
  - `compare_exchange_*()` CAS
- ä¼˜ç‚¹ï¼š
  - ç®€å•å¿«é€Ÿ
  - é€‚åˆè®¡æ•°å™¨ã€çŠ¶æ€æ ‡å¿—
- ç¼ºç‚¹ï¼š
  - åªèƒ½ä¿æŠ¤å•ä¸ªå°æ•°æ®
  - å¤æ‚åŒæ­¥åœºæ™¯éœ€è¦é”

## æ€»ç»“

> **åŸå­ç±»å‹ç”¨æ¥ä¿æŠ¤ç®€å•å˜é‡ï¼ŒCASæ˜¯èƒŒåçš„åŸç†ï¼Œå¿«ä¸”æ— é”ï¼Œä½†æ³¨æ„ ABA é—®é¢˜ã€‚**

```c++
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯»å–å½“å‰å€¼   â”‚
â”‚  old = *ptr   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ old == é¢„æœŸ expected ? â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      æ˜¯ âœ” â”‚        å¦ âœ–
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ *ptr = æ–°å€¼ desired â”‚   â”‚ ä¸æ”¹ï¼Œè¿”å›å¤±è´¥       â”‚
â”‚ è¿”å›æˆåŠŸ true    â”‚   â”‚ å¯ä»¥é€‰æ‹©é‡è¯•         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



# socket-recvè¿”å›å€¼

## `recv()` è¿”å› `0`

#### **å«ä¹‰**ï¼š

- **å¯¹æ–¹å·²æ­£å¸¸å…³é—­è¿æ¥**ï¼ˆå‘é€äº†FINåŒ…ï¼Œå³`EOF`ï¼‰ã€‚
- è¿™æ˜¯TCPè¿æ¥æ­£å¸¸ç»ˆæ­¢çš„ä¸€éƒ¨åˆ†ã€‚

#### **å¸¸è§åœºæ™¯**ï¼š

1. **å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­**ï¼š
   - å®¢æˆ·ç«¯è°ƒç”¨`close()`æˆ–`shutdown(SHUT_WR)`åï¼ŒæœåŠ¡ç«¯çš„`recv()`ä¼šè¿”å›`0`ã€‚
2. **æœåŠ¡ç«¯ä¸»åŠ¨å…³é—­**ï¼š
   - æœåŠ¡ç«¯å…³é—­è¿æ¥åï¼Œå®¢æˆ·ç«¯çš„`recv()`ä¼šè¿”å›`0`ã€‚
3. **HTTPè¯·æ±‚ç»“æŸ**ï¼š
   - HTTPåè®®ä¸­ï¼ŒæœåŠ¡å™¨å‘é€å®Œå“åº”åå¯èƒ½ä¼šå…³é—­è¿æ¥ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯`recv()`è¿”å›`0`ã€‚

#### **å¤„ç†æ–¹å¼**ï¼š

```
if (bytes_received == 0) {
    // å¯¹æ–¹å·²å…³é—­è¿æ¥
    close(socket_fd);  // é‡Šæ”¾èµ„æº
    printf("Connection closed by peer.\n");
}
```

------

## `recv()` è¿”å› `-1`

#### **å«ä¹‰**ï¼š

- **æ¥æ”¶æ•°æ®å‡ºé”™**ï¼Œå…·ä½“åŸå› éœ€é€šè¿‡`errno`åˆ¤æ–­ã€‚

#### **å¸¸è§åœºæ™¯åŠ`errno`å€¼**ï¼š

| `errno`                    | åŸå›                                         | å¤„ç†å»ºè®®                   |
| :------------------------- | :------------------------------------------ | :------------------------- |
| **`EAGAIN`/`EWOULDBLOCK`** | éé˜»å¡æ¨¡å¼ä¸‹æ— æ•°æ®å¯è¯»                      | å¯å¿½ç•¥ï¼Œç»§ç»­è½®è¯¢æˆ–ç­‰å¾…ã€‚   |
| **`ECONNRESET`**           | è¿æ¥è¢«å¯¹æ–¹å¼ºåˆ¶é‡ç½®ï¼ˆå¦‚è¿›ç¨‹å´©æºƒï¼‰            | å…³é—­socketï¼Œè®°å½•é”™è¯¯ã€‚     |
| **`ENOTCONN`**             | socketæœªè¿æ¥                                | æ£€æŸ¥è¿æ¥é€»è¾‘ã€‚             |
| **`EINTR`**                | ç³»ç»Ÿè°ƒç”¨è¢«ä¿¡å·ä¸­æ–­                          | å¯é‡è¯•`recv()`ã€‚           |
| **å…¶ä»–é”™è¯¯**               | å¦‚`EBADF`ï¼ˆæ— æ•ˆfdï¼‰ã€`ENOMEM`ï¼ˆå†…å­˜ä¸è¶³ï¼‰ç­‰ | å…³é—­socketï¼Œè®°å½•é”™è¯¯æ—¥å¿—ã€‚ |

#### **å¤„ç†æ–¹å¼**ï¼š

```
if (bytes_received == -1) {
    if (errno == EAGAIN || errno == EWOULDBLOCK) {
        // éé˜»å¡æ¨¡å¼ä¸‹çš„æ­£å¸¸æƒ…å†µï¼Œæ— éœ€å¤„ç†
    } 
    else if (errno == ECONNRESET) {
        // è¿æ¥è¢«å¯¹æ–¹å¼ºåˆ¶å…³é—­
        close(socket_fd);
        printf("Connection reset by peer.\n");
    } 
    else {
        // å…¶ä»–é”™è¯¯
        perror("recv() failed");
        close(socket_fd);
    }
}
```

------

### **å…³é”®æ€»ç»“**

| **è¿”å›å€¼** | **å«ä¹‰**            | **åç»­æ“ä½œ**                      |
| :--------- | :------------------ | :-------------------------------- |
| `> 0`      | æˆåŠŸæ¥æ”¶åˆ°æ•°æ®      | å¤„ç†æ•°æ®ã€‚                        |
| `0`        | å¯¹æ–¹æ­£å¸¸å…³é—­è¿æ¥    | å…³é—­socketï¼Œé‡Šæ”¾èµ„æºã€‚            |
| `-1`       | å‡ºé”™ï¼ˆéœ€æŸ¥`errno`ï¼‰ | æ ¹æ®`errno`å†³å®šé‡è¯•ã€å…³é—­æˆ–æŠ¥é”™ã€‚ |

------

### **æœ€ä½³å®è·µ**

1. **å§‹ç»ˆæ£€æŸ¥è¿”å›å€¼**ï¼šåŒºåˆ†`0`å’Œ`-1`æ˜¯å¥å£®æ€§ç¼–ç¨‹çš„åŸºç¡€ã€‚
2. **å¤„ç†éé˜»å¡æ¨¡å¼**ï¼šå¯¹`EAGAIN`/`EWOULDBLOCK`åšç‰¹æ®Šå¤„ç†ã€‚
3. **èµ„æºé‡Šæ”¾**ï¼šåœ¨è¿”å›`0`æˆ–ä¸å¯æ¢å¤çš„é”™è¯¯æ—¶ï¼ŒåŠæ—¶å…³é—­socketã€‚
4. **æ—¥å¿—è®°å½•**ï¼šè®°å½•é”™è¯¯è¯¦æƒ…ï¼ˆå¦‚`errno`ï¼‰ï¼Œä¾¿äºè°ƒè¯•ã€‚



## æœåŠ¡å™¨å‘ç”Ÿæ®µé”™è¯¯

## å®¢æˆ·ç«¯çš„ recv æ˜¯**å¯èƒ½è¿”å›0**çš„